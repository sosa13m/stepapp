<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calibración - StepApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
    }

    #contenedor {
      width: 100vw;
      height: 100vh;
      background-color: white;
      border-radius: 20px 20px 0 0;
      overflow: hidden;
      position: relative;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
    }

    #grid-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    #canvas-foto {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
    }

    #medida-cm {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
    }

    .control-btn {
      position: absolute;
      z-index: 5;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
    }

    #instrucciones {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 6;
      background-color: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="contenedor" class="animate__animated animate__fadeIn">
  <div id="instrucciones">
    Ubica el pie a unos 50-70 cm de la cámara (altura de la rodilla). Asegúrate de tener buena iluminación y que se vean bien el talón y el dedo pulgar.
  </div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="grid-canvas"></canvas>
  <canvas id="canvas-foto"></canvas>
  <div id="medida-cm">Largo: 0.0 cm</div>
  <button id="btn-capturar" class="btn btn-primary control-btn animate__animated animate__pulse animate__infinite">Capturar</button>
</div>

<script>
  const video = document.getElementById("video");
  const gridCanvas = document.getElementById("grid-canvas");
  const gridCtx = gridCanvas.getContext("2d");
  const canvasFoto = document.getElementById("canvas-foto");
  const fotoCtx = canvasFoto.getContext("2d");
  const medidaTexto = document.getElementById("medida-cm");
  const btnCapturar = document.getElementById("btn-capturar");

  let puntos = [];
  let draggingIndex = -1;
  let imgActual = null;

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; })
    .catch(err => alert("No se pudo acceder a la cámara"));

  function dibujarCuadricula() {
    gridCanvas.width = video.clientWidth;
    gridCanvas.height = video.clientHeight;
    gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);

    gridCtx.strokeStyle = 'rgba(0,255,0,0.4)';
    gridCtx.lineWidth = 1;
    const terciosX = gridCanvas.width / 3;
    const terciosY = gridCanvas.height / 3;

    for (let i = 1; i < 3; i++) {
      gridCtx.beginPath();
      gridCtx.moveTo(terciosX * i, 0);
      gridCtx.lineTo(terciosX * i, gridCanvas.height);
      gridCtx.stroke();

      gridCtx.beginPath();
      gridCtx.moveTo(0, terciosY * i);
      gridCtx.lineTo(gridCanvas.width, terciosY * i);
      gridCtx.stroke();
    }
    requestAnimationFrame(dibujarCuadricula);
  }
  dibujarCuadricula();

  btnCapturar.addEventListener("click", () => {
    const track = video.srcObject.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    document.getElementById("contenedor").classList.add("animate__zoomOut");
    setTimeout(() => {
      imageCapture.takePhoto().then(blob => {
        const img = new Image();
        img.onload = () => {
          canvasFoto.style.display = "block";
          canvasFoto.width = window.innerWidth;
          canvasFoto.height = window.innerHeight;
          fotoCtx.drawImage(img, 0, 0, canvasFoto.width, canvasFoto.height);
          imgActual = img;
          puntos = [];
          actualizarCanvas();
        };
        img.src = URL.createObjectURL(blob);
      }).catch(err => alert("Error al capturar: " + err.message));
    }, 600);
  });

  function actualizarCanvas() {
    fotoCtx.clearRect(0, 0, canvasFoto.width, canvasFoto.height);
    fotoCtx.drawImage(imgActual, 0, 0, canvasFoto.width, canvasFoto.height);

    fotoCtx.fillStyle = "yellow";
    fotoCtx.strokeStyle = "blue";
    fotoCtx.lineWidth = 2;

    puntos.forEach((p, i) => {
      fotoCtx.beginPath();
      fotoCtx.arc(p.x, p.y, 8, 0, Math.PI * 2);
      fotoCtx.fill();
    });

    if (puntos.length === 2) {
      fotoCtx.strokeStyle = "green";
      fotoCtx.beginPath();
      fotoCtx.moveTo(puntos[0].x, puntos[0].y);
      fotoCtx.lineTo(puntos[1].x, puntos[1].y);
      fotoCtx.stroke();

      const distancia = Math.hypot(puntos[1].x - puntos[0].x, puntos[1].y - puntos[0].y);
      const factor = 0.1;
      const cm = (distancia * factor).toFixed(1);
      medidaTexto.textContent = `Largo: ${cm} cm`;
      localStorage.setItem("medida_cm", cm);
      setTimeout(() => { window.location.href = "foto-receta.html"; }, 1000);
    }
  }

  canvasFoto.addEventListener("pointerdown", e => {
    const rect = canvasFoto.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const idx = puntos.findIndex(p => Math.hypot(p.x - x, p.y - y) < 10);
    if (idx >= 0) {
      draggingIndex = idx;
    } else if (puntos.length < 2) {
      puntos.push({ x, y });
      actualizarCanvas();
    }
  });

  canvasFoto.addEventListener("pointermove", e => {
    if (draggingIndex >= 0) {
      const rect = canvasFoto.getBoundingClientRect();
      puntos[draggingIndex].x = e.clientX - rect.left;
      puntos[draggingIndex].y = e.clientY - rect.top;
      actualizarCanvas();
    }
  });

  canvasFoto.addEventListener("pointerup", () => draggingIndex = -1);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabase-config.js"></script>

</body>
</html>
