<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CalibraciÃ³n</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase-config.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: black;
    }

    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    #largoTexto {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 1.6rem;
      background-color: rgba(0,0,0,0.6);
      padding: 6px 12px;
      border-radius: 8px;
    }

    .botones {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 1rem;
      z-index: 2;
    }

    .botones button {
      padding: 12px 20px;
      font-size: 1.2rem;
      border: none;
      border-radius: 1.5rem;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    #repetirBtn {
      background-color: #ffc107;
    }

    #usarBtn {
      background-color: #28a745;
      color: white;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="largoTexto">Toca 2 puntos</div>

  <div class="botones">
    <button id="repetirBtn">ðŸ”„ Repetir</button>
    <button id="usarBtn">âœ… Usar</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const largoTexto = document.getElementById('largoTexto');
    let puntos = [];

    navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    })
    .then(stream => {
      video.srcObject = stream;
    });

    function redibujar() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (puntos.length > 0) {
        puntos.forEach((p, i) => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 12, 0, 2 * Math.PI);
          ctx.fillStyle = i === 0 ? "yellow" : "white";
          ctx.fill();
          ctx.fillStyle = "black";
          ctx.font = "18px sans-serif";
          ctx.fillText(i + 1, p.x - 5, p.y + 5);
        });
      }

      if (puntos.length === 2) {
        ctx.beginPath();
        ctx.moveTo(puntos[0].x, puntos[0].y);
        ctx.lineTo(puntos[1].x, puntos[1].y);
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 3;
        ctx.stroke();

        const distanciaPx = Math.hypot(puntos[1].x - puntos[0].x, puntos[1].y - puntos[0].y);
        const largoCm = (distanciaPx / window.innerHeight) * 25; // Ajuste aproximado
        largoTexto.innerText = `Largo: ${largoCm.toFixed(1)} cm`;
        largoTexto.dataset.valor = largoCm.toFixed(1);
      }
    }

    canvas.addEventListener('click', e => {
      if (puntos.length < 2) {
        puntos.push({ x: e.clientX, y: e.clientY });
        redibujar();
      }
    });

    document.getElementById('repetirBtn').addEventListener('click', () => {
      puntos = [];
      largoTexto.innerText = "Toca 2 puntos";
      redibujar();
    });

    document.getElementById('usarBtn').addEventListener('click', async () => {
      const largoFinal = largoTexto.dataset.valor;
      const codigo = localStorage.getItem('codigo_pedido') || `pedido-${Date.now()}`;

      const { error } = await supabase
        .from('pacientes')
        .update({ largo_pie: largoFinal })
        .eq('codigo_pedido', codigo);

      if (error) {
        alert("Error al guardar en Supabase");
        console.error(error);
      } else {
        window.location.href = 'foto-receta.html';
      }
    });

    window.addEventListener('resize', redibujar);
    video.addEventListener('loadeddata', redibujar);
  </script>
</body>
</html>
